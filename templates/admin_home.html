<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartCampus | Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background:#f5f7fb; overflow-x:hidden; }

  /* Navbar */
  nav { display:flex; justify-content:space-between; align-items:center;
    padding:1rem 2rem; background:#0067A5; color:#fff; position:sticky; top:0; z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  nav h1 { font-size:1.6rem; font-weight:600; }
  nav .nav-links a { color:#fff; text-decoration:none; margin-left:1.5rem; font-weight:500; transition:0.3s; }
  nav .nav-links a:hover { color:#00A99D; }

  /* Container */
  .container { display:flex; min-height:calc(100vh - 70px); }
  .sidebar { width:250px; background:#fff; padding:2rem 1rem; border-right:1px solid #e0e0e0;
    display:flex; flex-direction:column; gap:1.5rem; position:sticky; top:70px; }
  .sidebar a { text-decoration:none; color:#0067A5; font-weight:500; padding:0.8rem 1rem; border-radius:8px;
    transition:0.3s; display:flex; align-items:center; gap:0.8rem; }
  .sidebar a:hover { background:#00A99D; color:#fff; }

  .content { flex:1; padding:2rem; display:flex; flex-direction:column; gap:2rem; }

  /* Hero Section */
  .hero { background:#00A99D; color:#fff; padding:2rem; border-radius:16px;
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
    box-shadow:0 4px 20px rgba(0,0,0,0.1); }
  .hero h2 { font-size:1.8rem; margin-bottom:0.5rem; }
  .hero img { width:200px; max-width:100%; }

  /* Stats */
  .stats { display:flex; gap:1rem; flex-wrap:wrap; }
  .stat { flex:1; min-width:180px; background:#fff; padding:1rem 1.5rem; border-radius:12px;
    display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 6px 20px rgba(0,0,0,0.05); transition:0.3s; }
  .stat:hover { transform:translateY(-5px); }

  /* Cards */
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; }
  .card { background:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 6px 20px rgba(0,0,0,0.05);
    transition:0.4s; cursor:pointer; display:flex; flex-direction:column; justify-content:center; }
  .card:hover { transform:translateY(-8px); }
  .card i { font-size:2rem; color:#0067A5; margin-bottom:1rem; }

  /* Chatbot Button */
  .chatbot-btn {
    position:fixed; bottom:25px; right:25px; background:#0067A5; color:#fff;
    width:60px; height:60px; border-radius:50%; border:none;
    font-size:1.8rem; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,0.2);
    transition:0.3s; z-index:1200;
  }
  .chatbot-btn:hover { background:#00A99D; }

  /* Live Chat Panel */
  .chat-panel {
    position:fixed; top:0; right:-450px; width:450px; height:100%;
    background:#fff; box-shadow:-3px 0 15px rgba(0,0,0,0.2);
    display:flex; flex-direction:column; transition:right 0.4s ease;
    z-index:1100;
  }
  .chat-panel.open { right:0; }

  .chat-header {
    background:#0067A5; color:#fff; padding:1rem; display:flex;
    justify-content:space-between; align-items:center;
  }
  .chat-header h3 { margin:0; font-size:1.1rem; }
  .close-chat { cursor:pointer; font-size:1.2rem; }

  .chat-body { flex:1; display:flex; min-height: 0;}
  .chat-list {
    width:40%; border-right:1px solid #eee; overflow-y:auto;
    background:#f8fafc;
  }
  .chat-list-item {
    padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer;
    transition:0.2s;
  }
  .chat-list-item:hover, .chat-list-item.active {
    background:#e0f7f7;
  }
  .chat-list-item span {
    font-size:0.85rem; color:#555;
  }

  .chat-window {
    flex:1; display:flex; flex-direction:column; justify-content:space-between; min-height: 0;
  }
  .chat-messages { flex:1; padding:1rem; overflow-y:auto; scroll-behavior: smooth; min-height: 0;}
  /* Optional: nice scrollbar style */
  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }
  .chat-messages::-webkit-scrollbar-thumb {
    background-color: #00A99D;
    border-radius: 3px;
  }
  .chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .chat-message {
    margin-bottom:0.8rem; padding:0.6rem 1rem; border-radius:10px; max-width:80%;
  }
  .chat-message.admin { background:#0067A5; color:#fff; margin-left:auto; }
  .chat-message.student { background:#e8f5ff; color:#333; }

  .chat-input-area {
    display:flex; padding:0.8rem; border-top:1px solid #eee;
  }
  .chat-input-area input {
    flex:1; padding:0.6rem 1rem; border:1px solid #ccc;
    border-radius:20px; outline:none;
  }
  .chat-input-area button {
    margin-left:0.6rem; background:#0067A5; color:#fff;
    border:none; border-radius:50%; width:40px; height:40px;
    cursor:pointer; transition:0.3s;
  }
  .chat-input-area button:hover { background:#00A99D; }
  /* Hide chat button */
  .chatbot-btn.hidden {
    display: none;
  }

  /* Tickets & Appointments */
  /* ------------------- */
  /* Section */
  .tickets-appointments { margin-top:2rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.5rem; }

  /* Cards */
  .ticket-card, .appointment-card {
    background:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 6px 20px rgba(0,0,0,0.05);
    transition:0.4s; cursor:pointer; display:flex; flex-direction:column; justify-content:center;
  }
  .ticket-card:hover, .appointment-card:hover { transform:translateY(-8px); }
  .ticket-card i, .appointment-card i { font-size:2rem; color:#0067A5; margin-bottom:1rem; }

  /* Tables */
  table {
    width:100%; margin-top:1rem; border-collapse: collapse;
  }
  th, td {
    padding:0.8rem; text-align:left; border-bottom:1px solid #eee;
  }
  th {
    background:#f1f1f1; color:#333;
  }
  tr:hover {
    background:#f9f9f9;
  }

  /* Modal */
  #ticket-modal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:2000;
  }
  #ticket-modal > div {
    background:#fff; border-radius:12px; padding:2rem; width:500px; max-width:90%; max-height:90%; overflow-y:auto; position:relative;
  }
  #close-ticket-modal {
    position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.2rem;
  }
  #ticket-subject {
    margin:0 0 1rem 0;
    font-size:1.3rem; font-weight:500;
  }
  #ticket-status, #ticket-assign {
    width:100%; padding:0.6rem; border:1px solid #ccc;
    border-radius:6px; margin-top:0.5rem;
  }
  #update-ticket {
    background:#00A99D; color:white; padding:0.6rem 1.2rem; border:none; border-radius:6px;
    cursor:pointer; transition:0.3s; margin-top:1rem;
  }
  #update-ticket:hover {
    background:#009688;
  }

  .ticket-item, .appointment-item {
    background:#fdfdfd;
    box-shadow:0 3px 10px rgba(0,0,0,0.05);
    transition:0.3s;
  }
  .ticket-item:hover, .appointment-item:hover {
    transform:translateY(-3px);
  }
  .ticket-item button, .appointment-item button {
    background:#0067A5; color:#fff; border:none; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;
  }
  .ticket-item button:hover, .appointment-item button:hover {
    background:#00A99D;
  }

  /* Chat Badge */
  .chat-badge {
    position: absolute;
    top: -10px; /* Move slightly further away from the button */
    right: -10px;
    background: red;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 12px;
    display: none;
    z-index: 1; /* Ensure it is below the button */
    pointer-events: none; /* Completely disable interactions */
  }
  /* Navbar */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: #0067A5;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Brand section: logo + text */
    .nav-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    nav h1 {
      font-size: 1.6rem;
      font-weight: 600;
    }

    nav .logo {
      width: 52px;
      height: 45px;
      object-fit: contain;
      padding: 4px;
    }


    /* Links section */
    nav .nav-links a {
      color: #fff;
      text-decoration: none;
      margin-left: 1.5rem;
      font-weight: 500;
      transition: 0.3s;
    }

    nav .nav-links a:hover {
      color: #00A99D;
    }
</style>
</head>
<body>
<nav>
    <div class="nav-left">
      <img src="{{ url_for('static', path='assets/images/logo.png') }}" alt="SmartCampus Logo" class="logo">
      <h1>SmartCampus</h1>
    </div>

    <div class="nav-links">
      <a href="/">Home</a>

      {% if request.session.get('user') %}
      {% set u = request.session.get('user') %}

      {# role-aware dashboard link #}
      {% if u.role == 'student' %}
      <a href="/student_home">Dashboard</a>
      {% elif u.role == 'staff' %}
      <a href="/staff_home">Dashboard</a>
      {% elif u.role == 'admin' %}
      <a href="/admin_home">Dashboard</a>
      {% endif %}

      <a href="/forum">Community</a>
      <a href="/edit_profile">
        Profile
      </a>
      <a href="/logout">Logout</a>
      {% else %}
      <a href="/login">Portal</a>
      {% endif %}
    </div>
  </nav>

<!-- Main Layout -->
<div class="container">

  <div class="content">
    <div class="hero">
      <div>
        <h2>Welcome, {{user.full_name}} ðŸ‘‹</h2>
        <p>Manage knowledge base, departments, users, and view analytics at a glance.</p>
      </div>
      <img src="https://img.icons8.com/ios/200/ffffff/admin-settings-male.png" alt="Admin Illustration">
    </div>

        <div class="stats">
      <div class="stat"><div><div class="number" id="knowledge-stat">0</div><div class="label">Knowledge Articles</div></div><i class="fa-solid fa-book"></i></div>
      <div class="stat"><div><div class="number" id="departments-stat">0</div><div class="label">Departments</div></div><i class="fa-solid fa-building-columns"></i></div>
      <div class="stat"><div><div class="number" id="users-stat">0</div><div class="label">Total Users</div></div><i class="fa-solid fa-user-gear"></i></div>
    </div>

    <div class="grid">
      <a href="/knowledge_base" style="text-decoration: none; color: inherit;">
        <div class="card">
          <i class="fa-solid fa-book"></i>
          <h3>Knowledge Base</h3>
          <p>Add, edit, or remove FAQ articles and guides.</p>
        </div>
      </a>
      <div class="card" onclick="showDepartmentsSection()"><i class="fa-solid fa-building-columns"></i><h3>Departments</h3><p>View and manage all TAMUCC departments and services.</p></div>
      <div class="card" onclick="showUserManagement()"><i class="fa-solid fa-user-gear"></i><h3>User Management</h3><p>Manage students, staff, and admin access and permissions.</p></div>
    </div>

    <!-- Tickets & Appointments Section -->
    <div class="grid" style="margin-top:2rem;">

      <!-- Tickets Card -->
      <div class="card" style="flex:2; min-width:400px;">
        <i class="fa-solid fa-ticket"></i>
        <h3>Open Tickets</h3>
        <p>View, assign, and manage student-raised tickets.</p>

        <table style="width:100%; margin-top:1rem; border-collapse: collapse;">
          <thead>
            <tr style="background:#00A99D; color:white;">
              <th style="padding:0.5rem; text-align:left;">Student</th>
              <th style="padding:0.5rem; text-align:left;">Subject</th>
              <th style="padding:0.5rem; text-align:left;">Priority</th>
              <th style="padding:0.5rem; text-align:left;">Status</th>
              <th style="padding:0.5rem; text-align:left;">Action</th>
            </tr>
          </thead>
          <tbody id="tickets-table">
            <!-- Tickets dynamically populated here -->
          </tbody>
        </table>
      </div>


    <!-- Ticket Details Modal -->
    <div id="ticket-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000;">
      <div style="background:#fff; border-radius:12px; padding:2rem; width:500px; max-width:90%; max-height:90%; overflow-y:auto; position:relative;">
        <span id="close-ticket-modal" style="position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.2rem;">&times;</span>
        <h3 id="ticket-subject">Ticket Subject</h3>
        <p><strong>Student:</strong> <span id="ticket-student"></span></p>
        <p><strong>Category:</strong> <span id="ticket-category"></span></p>
        <p><strong>Priority:</strong> <span id="ticket-priority"></span></p>
        <p><strong>Description:</strong></p>
        <p id="ticket-description"></p>
        <p><strong>Status:</strong>
          <select id="ticket-status">
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Closed">Closed</option>
          </select>
        </p>
        <p><strong>Assign Staff:</strong>
          <select id="ticket-assign">
            <!-- Staff list populated dynamically -->
          </select>
        </p>
        <button id="update-ticket" style="background:#00A99D; color:white; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer;">Update Ticket</button>
      </div>
    </div>

    <!-- Departments Modal -->
    <div id="departments-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000; overflow-y:auto;">
      <div style="background:#fff; border-radius:16px; padding:2rem; width:90%; max-width:1200px; max-height:90%; overflow-y:auto; position:relative; margin:2rem;">
        <span id="close-departments-modal" style="position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.5rem; color:#666;">&times;</span>
        <h2 style="color:#0067A5; margin-bottom:1.5rem;"><i class="fa-solid fa-building-columns"></i> TAMUCC Departments</h2>
        
        <div id="departments-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(350px, 1fr)); gap:1.5rem;">
          <!-- Departments will be populated here -->
        </div>
      </div>
    </div>

    <!-- User Management Modal -->
    <div id="user-management-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000; overflow-y:auto;">
      <div style="background:#fff; border-radius:16px; padding:2rem; width:90%; max-width:1400px; max-height:90%; overflow-y:auto; position:relative; margin:2rem;">
        <span id="close-user-modal" style="position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.5rem; color:#666;">&times;</span>
        <h2 style="color:#0067A5; margin-bottom:1.5rem;"><i class="fa-solid fa-user-gear"></i> User Management - Students</h2>
        
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr style="background:#0067A5; color:white;">
              <th style="padding:0.8rem; text-align:left;">Full Name</th>
              <th style="padding:0.8rem; text-align:left;">Email</th>
              <th style="padding:0.8rem; text-align:left;">Phone Number</th>
              <th style="padding:0.8rem; text-align:left;">Date of Birth</th>
              <th style="padding:0.8rem; text-align:left;">Address</th>
            </tr>
          </thead>
          <tbody id="students-table">
            <!-- Students will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Floating Chat Button -->
<button class="chatbot-btn" id="chat-toggle"><i class="fa-solid fa-comments"></i></button>

<!-- Live Chat Panel -->
<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <h3>Live Chat Requests</h3>
    <i class="fa-solid fa-xmark close-chat" id="close-chat"></i>
  </div>

  <div class="chat-body">
    <div class="chat-list" id="chat-list">
      <!-- Dynamic student list -->
    </div>

    <div class="chat-window">
      <div class="chat-messages" id="chat-messages">
        <p style="color:#999; text-align:center;">Select a chat to start messaging.</p>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type your message..." disabled>
        <button id="send-btn" disabled><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</div>

<script>
const chatToggle = document.getElementById('chat-toggle');
const chatPanel = document.getElementById('chat-panel');
const closeChat = document.getElementById('close-chat');
const chatList = document.getElementById('chat-list');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const chatBadge = document.createElement('span');
chatBadge.className = 'chat-badge';
chatBadge.style.cssText = 'position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; display: none;';
chatToggle.appendChild(chatBadge);


let queueCount = 0;
let ws;
let selectedSession = null;
const joinedSessions = new Set();      // sessions this admin has joined
const sessionsIndex  = new Map();      // session_id -> {name,status}


// Open/close panel with chat button hide/show
chatToggle.onclick = () => {
  chatPanel.classList.add('open');
  chatToggle.classList.add('hidden'); // hide the button when panel opens
};

closeChat.onclick = () => {
  chatPanel.classList.remove('open');
  chatToggle.classList.remove('hidden'); // show the button when panel closes
};

function updateBadge(count) {
  if (count > 0) {
    chatBadge.textContent = count;
    chatBadge.style.display = 'inline';
  } else {
    chatBadge.style.display = 'none';
  }
}

function showToast(message) {
  Toastify({
    text: message,
    duration: 3000,
    close: true,
    gravity: 'top',
    position: 'right',
    backgroundColor: 'linear-gradient(to right, #ff5f6d, #ffc371)',
  }).showToast();
}

function connectWebSocket() {
  ws = new WebSocket(`${location.origin.replace('http', 'ws')}/ws/admin`);

  ws.onopen = () => console.log("Connected to admin WebSocket.");
  ws.onclose = () => console.log("Disconnected from admin WebSocket.");

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'new_session') {
      queueCount += 1;
      updateBadge(queueCount);
      showToast(`New live chat request: ${data.name || 'Student'} (#${data.session_id.slice(0, 4)})`);
      upsertSession({ session_id: data.session_id, status: data.status || 'queued', name: data.name });
    }

    if (data.type === 'queued_ping') {
      const session = sessionsIndex.get(data.session_id);
      if (session) {
        session.queue_position = data.queue_position;
        upsertSession(session);
      }
    }

    if (data.type === 'session_removed') {
      queueCount = Math.max(0, queueCount - 1);
      updateBadge(queueCount);
      removeSession(data.session_id);
    }
  };
}

connectWebSocket();
</script>

<script>
window.onload = async () => {
  console.log("Window loaded. Initializing admin dashboard...");

  // Load live chat sessions
  await loadExistingSessions(); // Load sessions and messages
  clearMessages();
  connectWebSocket();           // Start WebSocket for live updates
  // Load tickets and appointments
  loadTickets();               // Load tickets for admin

  // Fetch stats
  try {
    const res = await fetch('/api/stats');
    if (res.ok) {
      const stats = await res.json();
      console.log('Stats fetched successfully:', stats);

      document.getElementById('knowledge-stat').textContent = stats.knowledge_articles || 0;
      document.getElementById('departments-stat').textContent = stats.departments || 0;
      document.getElementById('users-stat').textContent = stats.total_users || 0;
      document.getElementById('appointments-stat').textContent = stats.upcoming_appointments || 0;
    } else {
      console.error(`Failed to fetch stats. Status: ${res.status}`);
    }
  } catch (err) {
    console.error('Error fetching stats:', err);
  }
};

// ------------------- Helper Functions -------------------
function fallbackName(sessionId, name, fullName) {
  return fullName && fullName.trim() ? fullName : (name && name.trim() ? name : `Student ${sessionId?.slice(0, 4) || ''}`);
}

function upsertSession(session) {
  const sid = session.session_id;
  const name = fallbackName(sid, session.name, session.full_name);
  const status = session.status || 'queued';

  console.log(`[DEBUG] Upserting session: ${sid}, Name: ${name}, Status: ${status}`);

  // Store/merge local model
  const prev = sessionsIndex.get(sid) || {};
  sessionsIndex.set(sid, { name: name || prev.name, status });

  // Dedupe list item by data-id
  let item = chatList.querySelector(`.chat-list-item[data-id="${sid}"]`);
  if (!item) {
    item = document.createElement('div');
    item.classList.add('chat-list-item');
    item.dataset.id = sid;
    item.onclick = () => selectSession(sid);
    chatList.appendChild(item);
  }

  item.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>${name} <span style="color:#777">(${sid.slice(0,4)})</span></div>
      <span style="font-size:.7rem;padding:.1rem .4rem;border-radius:8px;background:${status==='live'?'#d1f7e6':'#fff3cd'};color:${status==='live'?'#0b6848':'#8a6d3b'};">
        ${status}
      </span>
    </div>
  `;

  console.log(`[DEBUG] Chat list updated for session: ${sid}`);
}

function clearMessages() {
  chatMessages.innerHTML = `<p style="color:#999; text-align:center;">Select a chat to start messaging.</p>`;
}

function removeSession(sessionId) {
  const item = chatList.querySelector(`.chat-list-item[data-id="${sessionId}"]`);
  if (item) item.remove();
  if (selectedSession === sessionId) {
    selectedSession = null;
    chatInput.disabled = true; sendBtn.disabled = true;
    chatMessages.innerHTML = `<p style="color:#999; text-align:center;">Select a chat to start messaging.</p>`;
  }
  sessionsIndex.delete(sessionId);
  joinedSessions.delete(sessionId);
}



function enableInput(enabled) {
  chatInput.disabled = !enabled;
  sendBtn.disabled   = !enabled;
}

// ---------- Select a session ----------
async function selectSession(sessionId) {
  selectedSession = sessionId;
  document.querySelectorAll('.chat-list-item').forEach(i => i.classList.remove('active'));
  document.querySelector(`.chat-list-item[data-id="${sessionId}"]`)?.classList.add('active');

  // reset window
  chatMessages.innerHTML = '';
  enableInput(false);

  // 1) Load chat history (backend: GET /api/chat/{session_id} returns a LIST)
  try {
    const res = await fetch(`/api/chat/${sessionId}`);
    const history = await res.json(); // [{sender, message, created_at}, ...]
    if (!Array.isArray(history)) throw new Error('Bad history payload');
    history.forEach(msg => appendMessage(sessionId, msg.sender, msg.message));
  } catch (err) {
    console.error('Failed to load chat messages:', err);
  }

  // 2) JOIN the session once per admin per session
  if (!joinedSessions.has(sessionId)) {
    console.log("Sending join request for session:", sessionId);
    ws?.send(JSON.stringify({ type: 'join', session_id: sessionId }));

    // wait for "joined" event to enable input
  } else {
    enableInput(true);
  }
}

// ---------- Load existing sessions on page load ----------
// Append a message to the chat window
function appendMessage(sessionId, sender, message) {
  if (sessionId !== selectedSession) return; // only show for selected session
  const div = document.createElement('div');
  div.classList.add('chat-message', sender === 'admin' ? 'admin' : 'student');
  div.textContent = message;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ---------- Send a message ----------
sendBtn.onclick = () => {
  const msg = chatInput.value.trim();
  if (!msg || !selectedSession) return;

  if (!joinedSessions.has(selectedSession)) {
    // safety: do not allow sending before joined
    return alert('Join the session first.');
  }

  ws.send(JSON.stringify({ type: 'message', session_id: selectedSession, message: msg }));
  appendMessage(selectedSession, 'admin', msg);
  chatInput.value = '';
};

// ---------- Load existing sessions on page load ----------
async function loadExistingSessions() {
  try {
    const res = await fetch('/api/admin/live_chats'); // returns [{session_id, status, name?}]
    const sessions = await res.json();
    sessions.forEach((s, idx) => {
      upsertSession(s);
      if (idx === 0) selectSession(s.session_id);
    });
  } catch (err) {
    console.error('Failed to load sessions:', err);
  }
}

// ---------- Admin WebSocket ----------
function connectWebSocket() {
  ws = new WebSocket(`${location.origin.replace('http', 'ws')}/ws/admin`);

  ws.onopen = () => console.log("Connected to live chat WebSocket.");
  ws.onclose = () => console.log("Disconnected from live chat WebSocket.");

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'new_session') {
      // session (queued) appears to admins
      upsertSession({ session_id: data.session_id, status: data.status || 'queued', name: data.name });
      if (!selectedSession) selectSession(data.session_id);
      return;
    }

    if (data.type === 'queued_ping') {
      // student typed while queued â€” keep as lightweight activity marker
      return;
    }

    if (data.type === 'joined') {
      // this admin successfully joined a session â†’ enable input
      if (data.session_id) {
        joinedSessions.add(data.session_id);
        upsertSession({ session_id: data.session_id, status: 'live' });
        if (selectedSession === data.session_id) enableInput(true);
      }
      return;
    }

    if (data.type === 'error') {
      console.warn('WS error:', data.reason);
      return;
    }

    if (data.type === 'message') {
      // Only messages for selected session are appended by appendMessage()
      appendMessage(data.session_id, data.sender, data.message);
      return;
    }

    if (data.type === 'session_removed') {
      removeSession(data.session_id);
      return;
    }

  };
}

// ------------------- Tickets & Appointments -------------------
// Load tickets from server
async function loadTickets() {
  try {
    console.log('Fetching tickets from backend...');
    const res = await fetch('/api/tickets'); // Ensure this endpoint matches your backend
    if (!res.ok) {
      console.error(`Failed to fetch tickets. Status: ${res.status}, Message: ${res.statusText}`);
      return;
    }
    const data = await res.json();
    console.log('Tickets fetched:', data);

    const tickets = data.tickets || []; // Extract tickets array from response
    const ticketsTable = document.getElementById('tickets-table');
    ticketsTable.innerHTML = '';

    // Fetch staff list once
    const staffRes = await fetch('/api/staff');
    const staffData = await staffRes.json();
    const staffList = Array.isArray(staffData) ? staffData : [];

    tickets.forEach(ticket => {
      const row = document.createElement('tr');
      const isAssigned = ticket.assigned_staff && ticket.assigned_staff !== 'Not Assigned Yet';
      const buttonText = isAssigned ? 'Assigned' : 'Assign';
      
      row.innerHTML = `
        <td>${ticket.student_name}</td>
        <td>${ticket.subject}</td>
        <td>${ticket.priority || 'N/A'}</td>
        <td>${ticket.status}</td>
        <td>
          <button class="assign-btn" style="background:#0067A5; color:#fff; border:none; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;">${buttonText}</button>
        </td>
      `;

      // Assign Staff click
      row.querySelector('.assign-btn').onclick = () => openTicketModal(ticket, staffList);

      ticketsTable.appendChild(row);
    });
  } catch (err) {
    console.error('Error fetching tickets:', err);
  }
}

// Load appointments from server
async function loadAppointments() {
  try {
    console.log('Fetching appointments from backend...');
    const res = await fetch('/api/appointments'); // Ensure this endpoint matches your backend
    if (!res.ok) {
      console.error(`Failed to fetch appointments. Status: ${res.status}, Message: ${res.statusText}`);
      return;
    }
    const data = await res.json();
    console.log('Appointments fetched:', data);

    const appointments = data.appointments || []; // Extract appointments array from response
    const appointmentsTable = document.getElementById('appointments-table');
    appointmentsTable.innerHTML = '';
    
    appointments.forEach(app => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${app.student_name}</td>
        <td>${app.department}</td>
        <td>${app.date} ${app.time}</td>
        <td>${app.status}</td>
      `;

      appointmentsTable.appendChild(row);
    });
  } catch (err) {
    console.error('Error fetching appointments:', err);
  }
}

// Ticket modal functions
const ticketModal = document.getElementById('ticket-modal');
const closeTicketModal = document.getElementById('close-ticket-modal');
closeTicketModal.onclick = () => ticketModal.style.display = 'none';

function openTicketModal(ticket, staffList) {
  ticketModal.style.display = 'flex';
  document.getElementById('ticket-subject').textContent = ticket.subject;
  document.getElementById('ticket-student').textContent = ticket.student_name;
  document.getElementById('ticket-category').textContent = ticket.category;
  document.getElementById('ticket-priority').textContent = ticket.priority;
  document.getElementById('ticket-description').textContent = ticket.description;
  document.getElementById('ticket-status').value = ticket.status;

  const assignSelect = document.getElementById('ticket-assign');
  assignSelect.innerHTML = '<option value="">-- Select Staff --</option>';
  
  staffList.forEach(staff => {
    const option = document.createElement('option');
    option.value = staff.email;
    option.textContent = `${staff.full_name} - ${staff.department}`;
    if(ticket.assigned_staff === staff.email) option.selected = true;
    assignSelect.appendChild(option);
  });

  document.getElementById('update-ticket').onclick = async () => {
    const updatedStatus = document.getElementById('ticket-status').value;
    const assignedStaff = document.getElementById('ticket-assign').value;

    try {
      await fetch(`/api/tickets/${ticket._id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: updatedStatus, assigned_staff: assignedStaff })
      });
      ticketModal.style.display = 'none';
      loadTickets(); // refresh table
    } catch (err) {
      console.error('Failed to update ticket:', err);
    }
  }
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch('/api/user'); // Fetch user details from backend
      if (res.ok) {
        const user = await res.json();
        const fullName = user.full_name || 'Admin'; // Default to 'Admin' if full_name is not available
        document.querySelector('.hero h2').textContent = `Welcome, ${fullName} ðŸ‘‹`;
      } else {
        console.error('Failed to fetch user details:', res.statusText);
      }
    } catch (err) {
      console.error('Error fetching user details:', err);
    }
  });

// ==================== DEPARTMENTS MANAGEMENT ====================

// Show departments modal
async function showDepartmentsSection() {
  const modal = document.getElementById('departments-modal');
  modal.style.display = 'flex';
  await loadDepartments();
}

// Close departments modal
document.getElementById('close-departments-modal').onclick = () => {
  document.getElementById('departments-modal').style.display = 'none';
};

// Load and display all departments
async function loadDepartments() {
  try {
    const res = await fetch('/api/departments');
    if (!res.ok) {
      console.error(`Failed to fetch departments. Status: ${res.status}`);
      return;
    }
    
    const departments = await res.json();
    const grid = document.getElementById('departments-grid');
    grid.innerHTML = '';

    if (departments.length === 0) {
      grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#999;">No departments found.</p>';
      return;
    }

    departments.forEach(dept => {
      const card = document.createElement('div');
      card.style.cssText = `
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: 0.3s;
        border-left: 4px solid #0067A5;
      `;
      card.onmouseover = () => card.style.transform = 'translateY(-5px)';
      card.onmouseout = () => card.style.transform = 'translateY(0)';

      card.innerHTML = `
        <h3 style="color:#0067A5; margin-bottom:0.5rem; font-size:1.1rem;">
          <i class="fa-solid fa-building"></i> ${dept.name}
        </h3>
        <p style="color:#666; font-size:0.9rem; margin-bottom:1rem;">${dept.description}</p>
        <div style="display:grid; gap:0.5rem; font-size:0.85rem;">
          <div><i class="fa-solid fa-location-dot" style="color:#00A99D; width:20px;"></i> <strong>Building:</strong> ${dept.building}</div>
          <div><i class="fa-solid fa-door-open" style="color:#00A99D; width:20px;"></i> <strong>Office:</strong> ${dept.office_location}</div>
          <div><i class="fa-solid fa-phone" style="color:#00A99D; width:20px;"></i> <strong>Phone:</strong> ${dept.phone}</div>
          <div><i class="fa-solid fa-envelope" style="color:#00A99D; width:20px;"></i> <strong>Email:</strong> ${dept.email}</div>
          <div><i class="fa-solid fa-clock" style="color:#00A99D; width:20px;"></i> <strong>Hours:</strong> ${dept.office_hours}</div>
        </div>
        ${dept.services && dept.services.length > 0 ? `
          <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #eee;">
            <strong style="color:#0067A5; font-size:0.85rem;">Services:</strong>
            <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem;">
              ${dept.services.map(s => `<span style="background:#e8f5ff; color:#0067A5; padding:0.2rem 0.6rem; border-radius:12px; font-size:0.75rem;">${s}</span>`).join('')}
            </div>
          </div>
        ` : ''}
      `;

      grid.appendChild(card);
    });
  } catch (err) {
    console.error('Error loading departments:', err);
  }
}

// ==================== USER MANAGEMENT ====================

// Show user management modal
async function showUserManagement() {
  const modal = document.getElementById('user-management-modal');
  modal.style.display = 'flex';
  await loadStudents();
}

// Close user management modal
document.getElementById('close-user-modal').onclick = () => {
  document.getElementById('user-management-modal').style.display = 'none';
};

// Load and display all students
async function loadStudents() {
  try {
    const res = await fetch('/api/students');
    if (!res.ok) {
      console.error(`Failed to fetch students. Status: ${res.status}`);
      return;
    }
    
    const students = await res.json();
    const tableBody = document.getElementById('students-table');
    tableBody.innerHTML = '';

    if (students.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999; padding:2rem;">No students found.</td></tr>';
      return;
    }

    students.forEach(student => {
      const row = document.createElement('tr');
      row.style.cssText = 'border-bottom: 1px solid #eee; transition: 0.2s;';
      row.onmouseover = () => row.style.background = '#f9f9f9';
      row.onmouseout = () => row.style.background = 'transparent';
      
      row.innerHTML = `
        <td style="padding:0.8rem;">${student.full_name || 'N/A'}</td>
        <td style="padding:0.8rem;">${student.email || 'N/A'}</td>
        <td style="padding:0.8rem;">${student.phone_number || 'N/A'}</td>
        <td style="padding:0.8rem;">${student.date_of_birth || 'N/A'}</td>
        <td style="padding:0.8rem;">${student.address || 'N/A'}</td>
      `;

      tableBody.appendChild(row);
    });
  } catch (err) {
    console.error('Error loading students:', err);
  }
}

</script>
</body>
</html>
