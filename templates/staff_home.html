<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartCampus | Staff Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background:#f5f7fb; }

  /* Navbar */
  nav {
    display:flex; justify-content:space-between; align-items:center;
    padding:1rem 2rem; background:#0067A5; color:#fff; position:sticky; top:0; z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
  }
  nav h1 { font-size:1.6rem; font-weight:600; }
  nav .nav-links a {
    color:#fff; text-decoration:none; margin-left:1.5rem; font-weight:500;
    transition:0.3s;
  }
  nav .nav-links a:hover { color:#00A99D; }

  /* Container */
  .container { display:flex; min-height:calc(100vh - 70px); }

  .sidebar {
    width:250px; background:#fff; padding:2rem 1rem; border-right:1px solid #e0e0e0;
    display:flex; flex-direction:column; gap:1.5rem; position:sticky; top:70px;
  }
  .sidebar a {
    text-decoration:none; color:#0067A5; font-weight:500; padding:0.8rem 1rem; border-radius:8px;
    transition:0.3s; display:flex; align-items:center; gap:0.8rem;
  }
  .sidebar a:hover { background:#00A99D; color:#fff; }

  .content { flex:1; padding:2rem; display:flex; flex-direction:column; gap:2rem; }

  /* Hero Section */
  .hero {
    background:#00A99D; color:#fff; padding:2rem; border-radius:16px;
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
  }
  .hero h2 { font-size:1.8rem; margin-bottom:0.5rem; }
  .hero p { font-size:1rem; opacity:0.9; }
  .hero img { width:200px; max-width:100%; }

  /* Stats Widgets */
  .stats { display:flex; gap:1rem; flex-wrap:wrap; }
  .stat {
    flex:1; min-width:180px; background:#fff; padding:1rem 1.5rem;
    border-radius:12px; display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 6px 20px rgba(0,0,0,0.05); transition:0.3s;
  }
  .stat:hover { transform:translateY(-5px); box-shadow:0 10px 25px rgba(0,0,0,0.15); }
  .stat .number { font-size:1.5rem; font-weight:600; color:#0067A5; }
  .stat .label { font-size:0.9rem; color:#555; }

  /* Ticket Table */
  .table-container { background:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 6px 20px rgba(0,0,0,0.05); overflow-x:auto; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:0.8rem; text-align:left; }
  th { background:#0067A5; color:#fff; border-radius:8px; }
  tr { border-bottom:1px solid #e0e0e0; transition:0.3s; }
  tr:hover { background:#f0f8ff; }

  .btn { padding:0.4rem 0.8rem; border:none; border-radius:8px; cursor:pointer; font-size:0.85rem; transition:0.3s; }
  .btn-respond { background:#00A99D; color:#fff; }
  .btn-respond:hover { background:#0067A5; }

  /* Chatbot Button */
  .chatbot-btn {
    position:fixed; bottom:25px; right:25px; background:#0067A5; color:#fff;
    width:60px; height:60px; border-radius:50%; border:none;
    font-size:1.8rem; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,0.2);
    transition:0.3s;
  }
  .chatbot-btn:hover { background:#00A99D; }

  @media(max-width:768px){
    .container { flex-direction:column; }
    .sidebar { width:100%; flex-direction:row; justify-content:space-around; border-right:none; border-bottom:1px solid #e0e0e0; padding:1rem 0.5rem; }
  }
  /* Navbar */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: #0067A5;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Brand section: logo + text */
    .nav-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    nav h1 {
      font-size: 1.6rem;
      font-weight: 600;
    }

    nav .logo {
      width: 52px;
      height: 45px;
      object-fit: contain;
      padding: 4px;
    }


    /* Links section */
    nav .nav-links a {
      color: #fff;
      text-decoration: none;
      margin-left: 1.5rem;
      font-weight: 500;
      transition: 0.3s;
    }

    nav .nav-links a:hover {
      color: #00A99D;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // 1) fill the "Select course..." dropdown using the *working* API
  async function loadCoursesForStaff() {
    const select = document.getElementById('material-course');

    // this one we know works
    const res = await fetch('/api/debug/courses');
    const data = await res.json();

    const courses = data.courses_preview || [];

    // reset
    select.innerHTML = '<option value="">Select course...</option>';

    courses.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c._id;
      opt.textContent = `${c.title} â€” ${c.details} (${c.term})`;
      select.appendChild(opt);
    });
  }

  // 2) load all materials into the table
  async function loadMaterialsForAllCourses() {
    const res = await fetch('/api/materials/all');
    const materials = await res.json();
    const tbody = document.getElementById('materials-table-body');
    tbody.innerHTML = '';

    materials.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.course_title || m.course_id}</td>
        <td>${m.title}</td>
        <td>${m.uploaded_by}</td>
        <td>${new Date(m.uploaded_at).toLocaleString()}</td>
        <td>${m.file_name ? `<a href="/uploads/${m.file_name}" target="_blank">Open</a>` : (m.external_url ? `<a href="${m.external_url}" target="_blank">Open</a>` : '')}</td>
        <td>
          <button class="btn btn-respond" onclick="deleteMaterial('${m._id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 3) delete material
  window.deleteMaterial = async function(id) {
    if (!confirm('Delete this material?')) return;
    const res = await fetch(`/api/materials/${id}`, { method: 'DELETE' });
    if (res.ok) {
      loadMaterialsForAllCourses();
    } else {
      alert('Failed to delete material');
    }
  };

  // 4) handle upload form
  const form = document.getElementById('material-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const res = await fetch('/api/materials', {
      method: 'POST',
      body: fd
    });
    if (res.ok) {
      form.reset();
      loadMaterialsForAllCourses();
    } else {
      alert('Failed to upload');
    }
  });

  // 5) initial load
  loadCoursesForStaff();
  loadMaterialsForAllCourses();
});
</script>



</head>
<body>

<!-- Navbar -->
<nav>
    <div class="nav-left">
      <img src="{{ url_for('static', path='assets/images/logo.png') }}" alt="SmartCampus Logo" class="logo">
      <h1>SmartCampus</h1>
    </div>

    <div class="nav-links">
      <a href="/">Home</a>

      {% if request.session.get('user') %}
      {% set u = request.session.get('user') %}

      {# role-aware dashboard link #}
      {% if u.role == 'student' %}
      <a href="/student_home">Dashboard</a>
      {% elif u.role == 'staff' %}
      <a href="/staff_home">Dashboard</a>
      {% elif u.role == 'admin' %}
      <a href="/admin_home">Dashboard</a>
      {% endif %}

      <a href="/forum">Community</a>
      <a href="/edit_profile">
        Profile
      </a>
      <a href="/logout">Logout</a>
      {% else %}
      <a href="/login">Portal</a>
      {% endif %}
    </div>
  </nav>

<!-- Container -->
<div class="container">



  <!-- Content -->
  <div class="content">

    <!-- Hero -->
    <div class="hero">
      <div>
        <h2>Welcome, {{user.full_name}} ðŸ‘‹</h2>
        <p>Manage tickets, respond to live chats, and view upcoming appointments efficiently.</p>
      </div>
      <img src="https://img.icons8.com/ios/200/ffffff/customer-support.png" alt="Staff Illustration">
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div>
          <div class="number">5</div>
          <div class="label">Pending Tickets</div>
        </div>
        <i class="fa-solid fa-ticket"></i>
      </div>
      <div class="stat">
        <div>
          <div class="number">2</div>
          <div class="label">Active Chats</div>
        </div>
        <i class="fa-solid fa-comments"></i>
      </div>
      <div class="stat">
        <div>
          <div class="number">3</div>
          <div class="label">Upcoming Appointments</div>
        </div>
        <i class="fa-solid fa-calendar-check"></i>
      </div>
    </div>

    <!-- Ticket Queue -->
    <div class="table-container">
      <h3>Ticket Queue</h3>
      <table>
        <thead>
          <tr>
            <th>Ticket ID</th>
            <th>Student</th>
            <th>Category</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>#101</td>
            <td>John Doe</td>
            <td>IT Support</td>
            <td>Pending</td>
            <td><button class="btn btn-respond">Respond</button></td>
          </tr>
          <tr>
            <td>#102</td>
            <td>Mary Smith</td>
            <td>Advising</td>
            <td>In Progress</td>
            <td><button class="btn btn-respond">Respond</button></td>
          </tr>
          <tr>
            <td>#103</td>
            <td>Kevin Lee</td>
            <td>Library Services</td>
            <td>Pending</td>
            <td><button class="btn btn-respond">Respond</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Course Materials -->
<div class="table-container" id="materials" style="margin-top: 2rem;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
    <h3 style="margin:0;">Course Materials</h3>
    <small style="color:#64748b; display:block; margin-bottom:0.25rem;">
        Showing courses assigned to you
      </small>

    <small style="color:#4b5563;">Upload materials for your courses</small>
  </div>

  <!-- Upload form -->
  <form id="material-form"
        enctype="multipart/form-data"
        style="
          background:#f8fafc;
          border:1px solid #e2e8f0;
          border-radius:0.75rem;
          padding:1rem;
          display:grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap:0.75rem;
          margin-bottom:1.25rem;
        ">
    <!-- row 1 -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="material-course" style="font-size:0.75rem; font-weight:600;">Course</label>
      <select id="material-course" name="course_id" required
              style="padding:0.5rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.5rem;">
        <option value="">Select course...</option>
      </select>
    </div>

    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="material-title" style="font-size:0.75rem; font-weight:600;">Title</label>
      <input type="text" id="material-title" name="title" placeholder="e.g. Week 1 slides" required
             style="padding:0.5rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.5rem;">
    </div>

    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="material-desc" style="font-size:0.75rem; font-weight:600;">Description</label>
      <input type="text" id="material-desc" name="description" placeholder="optional"
             style="padding:0.5rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.5rem;">
    </div>

    <!-- row 2 -->
    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="material-file" style="font-size:0.75rem; font-weight:600;">Upload file</label>
      <input type="file" id="material-file" name="file"
             accept=".pdf,.ppt,.pptx,.doc,.docx"
             style="padding:0.35rem 0.2rem; border:1px solid #cbd5e1; border-radius:0.5rem; background:white;">
      <small style="font-size:0.65rem; color:#6b7280;">PDF / PPT / DOC</small>
    </div>

    <div style="display:flex; flex-direction:column; gap:0.25rem;">
      <label for="material-url" style="font-size:0.75rem; font-weight:600;">or external URL</label>
      <input type="url" id="material-url" name="external_url" placeholder="https://..."
             style="padding:0.5rem 0.6rem; border:1px solid #cbd5e1; border-radius:0.5rem;">
    </div>

    <div style="display:flex; align-items:flex-end;">
      <button type="submit"
              class="btn btn-respond"
              style="padding:0.55rem 1.2rem; border-radius:0.5rem;">
        Upload
      </button>
    </div>
  </form>

  <!-- list -->
  <div style="overflow-x:auto;">
    <table style="width:100%; min-width:700px;">
      <thead>
        <tr>
          <th>Course</th>
          <th>Title</th>
          <th>Uploaded By</th>
          <th>Date</th>
          <th>Link</th>
          <th style="width:90px;">Action</th>
        </tr>
      </thead>
      <tbody id="materials-table-body">
        <!-- populated by JS -->
      </tbody>
    </table>
  </div>
</div>



  </div>
</div>

<!-- Chatbot Button -->
<button class="chatbot-btn"><i class="fa-solid fa-comments"></i></button>

</body>
</html>
